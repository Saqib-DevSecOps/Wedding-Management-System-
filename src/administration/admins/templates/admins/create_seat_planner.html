{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}
{% load humanize %}

{% block subtitle %} {{ request.user }} {% endblock %}
{% block page_heading %}
{% endblock %}

{% block only-body %}
<style>
     .circle-container {
        width: 150px;
        height: 150px;
        border: 2px solid #000;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .rectangle-container {
        width: 200px;
        height: 140px;
        border: 2px solid #000;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .guest {
        background-color: #f0f0f0;
        padding: 5px;
        margin: 5px;
        cursor: move;
    }
</style>
<div aria-hidden="true" aria-labelledby="GuestGroupModelLabel" class="modal fade" id="GuestGroupModal" role="dialog"
     tabindex="-1">
    <div class="modal-dialog " role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="GuestGroupModelLabel">Add Provider</h5>
                <button aria-label="Close" class="close" data-dismiss="modal" type="button">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="ml-3">
                <div class="create_modal_errors">

                </div>

            </div>
            <!-- Add 'id' attribute to the form element -->
            <form id="provider-form">
                {% csrf_token %}
                {% crispy form %}

                <div class="modal-body">
                    <div class="form-group">
                        <button class="btn btn-danger" data-dismiss="modal" type="button">Close</button>
                        <button class="btn btn-outline-success" id="save-provider" type="submit">Save</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-2 card border-1 ml-auto mr-auto mb-4">
        <div class="">
            <div class="card-title text-center">
                <h3 class="mt-3 text-success"><b>Guests</b></h3>
            </div>
        </div>
        <hr>
        <div class="card-body" style="overflow-y: auto;height: 78vh;overflow-x: hidden">
            <div class="list-group list-group-light">
                {% for object in guests %}
                <a aria-current="true"
                   class="list-group-item list-group-item-action px-3 border-1 m-1 ripple text-center draggable-guest"
                   data-container-type="{{ tableType }}" href="#">
                    <b>{{ object.guest_name }}</b>
                </a>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="col-md-9 card ml-auto mr-auto">
        <div class="">
            <div class="card-title text-center">
                <div class="row">
                    <div class="col-10">
                        <h3 class="mt-3 text-center text-success"><b>Seat Planner</b></h3>
                    </div>
                    <div class="col-2">
                        <button class="btn btn-outline-success mt-3 update-button" data-target="#GuestGroupModal"
                                data-toggle="modal" data-whatever="@getbootstrap">
                            <i class="fa fa-plus"></i>Add Table
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <hr>
        <div class="card-body" style="overflow-y: auto;height: 78vh;">
            <div class="row justify-center">
                <!-- Empty container for circle -->
                <div class="draggable-container" id="circle_container">
                </div>

                <!-- Empty container for rectangle -->
                <div class="draggable-container" id="rectangle_container">
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.0/jquery-ui.js"></script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js"></script>

<script>
    $(document).ready(function () {
        // Make the entire container draggable
        // Make the guest names draggable
        $('.draggable-guest').draggable({
            revert: 'invalid', // Revert back to the original position if not dropped in a container
            helper: 'clone', // Create a clone of the dragged element
            cursor: 'move' // Set the cursor style during dragging
        });

        // Make the containers droppable
        $('.draggable-container').droppable({
            accept: '.draggable-guest', // Only accept guest names as droppable elements
            drop: function (event, ui) {
                // Get the dropped guest name
                var guestName = ui.helper.text();

                // Get the container type where the guest should be dropped
                var containerType = ui.helper.data('container-type');

                // Create a new guest element and append it to the container
                var guestElement = $('<div class="guest"></div>').text(guestName);

                // Append the guest to the dropped container
                if (containerType === '1') {
                    $(this).find('.circle-container').append(guestElement);
                } else if (containerType === '2') {
                    $(this).find('.rectangle-container').append(guestElement);
                }
            }
        });

        // Handle save button click
        $('#save-provider').click(function () {
            // Get the values from the form
            var tableName = $('#id_table_name').val();
            var tableType = $('#id_table_type').val();
            var tableSize = $('#id_seat_count').val();

            // Check if all fields are filled
            if (tableName.trim() === '' || tableType.trim() === '' || tableSize.trim() === '') {
                // Show an error message or perform any desired action
                return;
            }

            // Create a unique ID for the new container
            var containerId = 'container_' + Date.now();

            // Create the HTML for the new container based on the table type
            var containerHtml = '';
            if (tableType === '1') {
                containerHtml = `
                <div class="draggable-container" id="${containerId}">
                    <h5>Table Name: <span>${tableName}</span></h5>
                    <h5>Table Size: <span>${tableSize}</span></h5>
                    <div class="circle-container"></div>
                </div>
            `;
            } else if (tableType === '2') {
                containerHtml = `
                <div class="draggable-container" id="${containerId}">
                    <h5>Table Name: <span>${tableName}</span></h5>
                    <h5>Table Size: <span>${tableSize}</span></h5>
                    <div class="rectangle-container"></div>
                </div>
            `;
            }

            // Append the new container to the respective parent container
            if (tableType === '1') {
                $('#circle_container').append(containerHtml);
            } else if (tableType === '2') {
                $('#rectangle_container').append(containerHtml);
            }

            // Make the new container draggable
            $('#' + containerId).draggable();

            // Make the new container droppable
            $('#' + containerId).droppable({
                accept: '.draggable-guest',
                drop: function (event, ui) {
                    var guestName = ui.helper.text();
                    var guestElement = $('<div class="guest"></div>').text(guestName);
                    $(this).find('.circle-container, .rectangle-container').append(guestElement);
                }
            });

            // Close the modal
            $('#GuestGroupModal').modal('hide');
        });

        // Handle opening the modal
        $('.update-button').click(function () {
            $('#GuestGroupModal').modal('show');
        });
    });
</script>
{% endblock %}
